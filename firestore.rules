rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    let ADMIN_UID = "1EW8TCRo2LOdJEHrWrrVOTvJZJE2"; 

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isSignedIn() && request.auth.uid == ADMIN_UID;
    }
    
    // Loan Applications
    match /loanApplications/{applicationId} {
      // User can read their own to see status, Admin can read all.
      allow read: if isAdmin() || (isSignedIn() && 'userId' in resource.data && resource.data.userId == request.auth.uid);
      // Writes are handled by admin functions
      allow write: if isAdmin();
    }

    // Investment Applications
    match /investmentApplications/{investmentId} {
      // User can read their own. Admin can read all. Created via a function.
      allow read: if isAdmin() || (isSignedIn() && 'userId' in resource.data && resource.data.userId == request.auth.uid);
      allow write: if isAdmin(); // Functions and admin manage writes.
    }
    
    // Customers collection
    match /Customers/{customerId} {
      // Only admins should manage customer records directly.
      allow read, write: if isAdmin();
    }

    // Loans collection
    match /Loans/{loanId} {
      // User can read their own loans. Admin can manage all.
      allow read: if isAdmin() || (isSignedIn() && 'borrowerId' in resource.data && resource.data.borrowerId == request.auth.uid);
      allow write: if isAdmin(); // All writes are done by admin/functions
    }
  }
}
